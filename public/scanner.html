<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Absensi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { height: 100%; width: 250px; position: fixed; z-index: 20; top: 0; left: 0; background-color: #1a202c; overflow-x: hidden; transition: 0.5s; padding-top: 60px; }
        .sidebar a { padding: 10px 15px; text-decoration: none; font-size: 18px; color: #cbd5e0; display: block; transition: 0.3s; }
        .sidebar a:hover { color: #ffffff; background-color: #4a5568; }
        .sidebar .closebtn { position: absolute; top: 0; right: 25px; font-size: 36px; margin-left: 50px; display: none; }
        .main-content { transition: margin-left .5s; padding: 20px; }
        .openbtn { font-size: 20px; cursor: pointer; background-color: #1a202c; color: white; padding: 10px 15px; border: none; }
        #qr-reader { border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden; position: relative; }
        /* Kelas CSS untuk membalikkan video */
        #qr-reader video.mirrored {
            transform: scaleX(-1);
        }
        .modal { z-index: 30; }
        @media screen and (max-width: 768px) {
            .sidebar { width: 0; }
            .sidebar .closebtn { display: block; }
            .main-content { margin-left: 0 !important; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="mySidebar" class="sidebar">
        <a href="/dashboard.html"><i class="fas fa-tachometer-alt fa-fw mr-3"></i>Dashboard</a>
        <a href="/scanner.html" class="bg-gray-700 text-white"><i class="fas fa-qrcode fa-fw mr-3"></i>Scanner</a>
        <a href="/admin.html"><i class="fas fa-users-cog fa-fw mr-3"></i>Kelola Siswa</a>
        <a href="/sesi.html"><i class="fas fa-clock fa-fw mr-3"></i>Kelola Sesi</a>
        <a href="/laporan.html"><i class="fas fa-chart-bar fa-fw mr-3"></i>Laporan Harian</a>
        <a href="/grafik.html"><i class="fas fa-trophy fa-fw mr-3"></i>Grafik Peringkat</a>
        <a href="/broadcast.html"><i class="fas fa-bullhorn fa-fw mr-3"></i>Broadcast WA</a>
        <a href="/rekap.html"><i class="fas fa-file-invoice fa-fw mr-3"></i>Rekap Bulanan</a>
        <a href="/status.html"><i class="fas fa-signal fa-fw mr-3"></i>Status Sistem</a>
    </div>

    <div id="main" class="main-content">
        <button class="openbtn rounded-md mb-4" onclick="openNav()">&#9776; Menu</button>
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold mb-2 text-gray-800">Scanner Absensi</h1>
            <div id="active-session-info" class="mb-6 bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md" role="alert">Memuat info sesi...</div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Arahkan QR Code ke Kamera</h2>
                    <div class="flex flex-wrap gap-4 items-center mb-4">
                        <div id="camera-selector-container" class="flex-grow hidden">
                            <select id="camera-select" class="w-full p-2 border-gray-300 rounded-md"></select>
                        </div>
                        <button id="mirror-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded inline-flex items-center">
                            <i class="fas fa-camera-rotate mr-2"></i>Balikkan Tampilan
                        </button>
                    </div>
                    <div id="qr-reader" class="w-full bg-gray-900 aspect-square md:aspect-video"></div>
                    <div id="scan-result" class="mt-4 text-center font-medium"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Absensi Hari Ini</h2>
                    <div class="overflow-y-auto h-96">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center modal hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4 p-6 text-center transform transition-all">
            <div id="modal-content"></div>
            <div id="modal-status" class="mt-4 text-sm font-medium"></div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="cancel-scan-btn" class="py-2 px-6 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md font-semibold">Batal</button>
                <button id="confirm-scan-btn" class="py-2 px-6 bg-green-500 hover:bg-green-600 text-white rounded-md font-semibold">Konfirmasi Hadir</button>
            </div>
        </div>
    </div>

    <script>
        // --- Sidebar Logic ---
        function openNav() {
            if (window.innerWidth > 768) {
                document.getElementById("mySidebar").style.width = "250px";
                document.getElementById("main").style.marginLeft = "250px";
            } else {
                document.getElementById("mySidebar").style.width = "250px";
            }
        }
        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            if (window.innerWidth > 768) {
                document.getElementById("main").style.marginLeft = "0";
            }
        }
        if (window.innerWidth > 768) { openNav(); }

        // --- Aplikasi Logic ---
        const scanResultEl = document.getElementById('scan-result');
        let html5QrCode; // Diubah dari html5QrcodeScanner
        
        // --- Logika Kontrol Kamera ---
        const mirrorBtn = document.getElementById('mirror-btn');
        mirrorBtn.addEventListener('click', () => {
            const video = document.querySelector('#qr-reader video');
            if (video) video.classList.toggle('mirrored');
        });

        // --- Logika Modal Konfirmasi ---
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalContent = document.getElementById('modal-content');
        const modalStatus = document.getElementById('modal-status');
        const confirmBtn = document.getElementById('confirm-scan-btn');
        const cancelBtn = document.getElementById('cancel-scan-btn');
        
        cancelBtn.addEventListener('click', closeConfirmationModal);
        
        function closeConfirmationModal() {
            confirmationModal.classList.add('hidden');
            // PERBAIKAN: Selalu coba resume scanner saat modal ditutup
            if (html5QrCode && html5QrCode.getState() === 2) { // 2 = PAUSED
                html5QrCode.resume();
            }
        }

        async function showConfirmationModal(studentId) {
            // PERBAIKAN: Jeda scanner saat QR terdeteksi
            if (html5QrCode && html5QrCode.getState() === 1) { // 1 = SCANNING
                 html5QrCode.pause();
            }
            modalContent.innerHTML = '<p class="py-8">Memverifikasi data siswa...</p>';
            modalStatus.innerHTML = '';
            confirmBtn.disabled = true; // Nonaktifkan tombol saat loading
            confirmationModal.classList.remove('hidden');

            try {
                const response = await fetch(`/api/student/${studentId}/details`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);

                const photoHTML = data.photo_url
                    ? `<img src="/uploads/${data.photo_url}" alt="${data.name}" class="h-24 w-24 rounded-full object-cover mx-auto mb-4 border-4 border-gray-200">`
                    : `<div class="h-24 w-24 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold text-4xl mx-auto mb-4">${(data.name || '').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase()}</div>`;

                modalContent.innerHTML = `
                    ${photoHTML}
                    <h3 class="text-2xl font-bold text-gray-800">${data.name}</h3>
                    <p class="text-gray-500">ID: ${studentId}</p>
                `;
                
                confirmBtn.onclick = () => sendScanData(studentId);
                confirmBtn.disabled = false; // Aktifkan tombol lagi

            } catch (error) {
                modalContent.innerHTML = `<p class="text-red-500 font-semibold py-8">${error.message}</p>`;
                confirmBtn.onclick = null;
                // Tutup otomatis setelah 3 detik jika data siswa tidak ditemukan
                setTimeout(closeConfirmationModal, 3000);
            }
        }

        // --- Logika Absensi ---
        function onScanSuccess(decodedText, decodedResult) {
            showConfirmationModal(decodedText);
        }

        async function sendScanData(studentId) {
            modalStatus.innerHTML = `<p class="text-blue-600">Mencatat kehadiran...</p>`;
            confirmBtn.disabled = true;
            cancelBtn.disabled = true;
            try {
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId: studentId })
                });
                const result = await response.json();
                if (response.ok) {
                    modalStatus.innerHTML = `<p class="text-green-600 animate-pulse">${result.message}</p>`;
                    fetchAttendanceData();
                    setTimeout(closeConfirmationModal, 1500);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                modalStatus.innerHTML = `<p class="text-red-500">${error.message}</p>`;
                 setTimeout(closeConfirmationModal, 3000);
            } finally {
                // Selalu aktifkan tombol lagi setelah selesai, kecuali saat berhasil
                if(!confirmationModal.classList.contains('hidden')){
                    confirmBtn.disabled = false;
                    cancelBtn.disabled = false;
                }
            }
        }

        async function fetchAttendanceData() {
             try {
                const response = await fetch('/api/attendance/today');
                if (!response.ok) throw new Error('Gagal mengambil data absensi.');
                const data = await response.json();
                const tableBody = document.getElementById('attendance-table');
                tableBody.innerHTML = '';
                if(Array.isArray(data)) {
                    data.forEach(item => {
                        const statusClass = item.status === 'Tepat Waktu' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                        const row = `<tr>
                            <td class="px-6 py-4 whitespace-nowrap">${item.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${item.time}</td>
                            <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${item.status}</span></td>
                        </tr>`;
                        // Masukkan baris baru di paling atas
                        tableBody.insertAdjacentHTML('afterbegin', row);
                    });
                }
            } catch (error) {
                console.error('Gagal mengambil data absensi:', error);
            }
        }

        async function fetchActiveSession() {
            const sessionInfoEl = document.getElementById('active-session-info');
            try {
                const response = await fetch('/api/sessions');
                if (!response.ok) throw new Error('Gagal mengambil data sesi.');
                const sessions = await response.json();
                const activeSession = Array.isArray(sessions) ? sessions.find(s => s.is_active) : null;

                if (activeSession) {
                    sessionInfoEl.innerHTML = `
                        <p class="font-bold">${activeSession.session_name}</p>
                        <p>Batas telat hari ini adalah pukul ${activeSession.late_time}.</p>`;
                } else {
                    sessionInfoEl.innerHTML = `
                        <p class="font-bold text-red-700">Tidak Ada Sesi Aktif</p>
                        <p class="text-red-700">Silakan aktifkan sesi di halaman 'Kelola Sesi' untuk memulai absensi.</p>`;
                }
            } catch (error) {
                sessionInfoEl.innerHTML = `<p class="font-bold text-red-700">Gagal memuat info sesi.</p>`;
            }
        }
        
        function startScanner(cameraId) {
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start(
                cameraId, 
                config, 
                onScanSuccess, 
                (errorMessage) => { /* Abaikan error pemindaian berkelanjutan */ }
            ).catch(err => {
                console.error("Gagal memulai scanner:", err);
            });
        }

        function setupCamera() {
            html5QrCode = new Html5Qrcode("qr-reader");
            const cameraSelect = document.getElementById('camera-select');
            const selectorContainer = document.getElementById('camera-selector-container');
            
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    let preferredCameraId = devices[0].id;
                    let isFrontCamera = false;
                    
                    if (devices.length > 1) {
                        selectorContainer.classList.remove('hidden');
                        devices.forEach(device => {
                            const option = new Option(device.label || `Kamera ${cameraSelect.length + 1}`, device.id);
                            cameraSelect.add(option);
                            // Coba deteksi kamera belakang sebagai default
                            if (device.label.toLowerCase().includes('back')) {
                                preferredCameraId = device.id;
                            }
                        });
                        cameraSelect.value = preferredCameraId;
                    }

                    // PERBAIKAN: Cek apakah kamera yang dipilih adalah kamera depan (untuk mirroring)
                    const selectedDevice = devices.find(d => d.id === preferredCameraId);
                    if (selectedDevice && (selectedDevice.label.toLowerCase().includes('front') || selectedDevice.label.toLowerCase().includes('webcam'))) {
                         isFrontCamera = true;
                    }
                    
                    const videoElement = document.querySelector('#qr-reader video');
                    if(isFrontCamera){
                        if(videoElement) videoElement.classList.add('mirrored');
                    } else {
                        if(videoElement) videoElement.classList.remove('mirrored');
                    }

                    startScanner(preferredCameraId);

                    cameraSelect.addEventListener('change', () => {
                        html5QrCode.stop().then(() => {
                            const newCameraId = cameraSelect.value;
                            const newSelectedDevice = devices.find(d => d.id === newCameraId);
                            if (newSelectedDevice && (newSelectedDevice.label.toLowerCase().includes('front') || newSelectedDevice.label.toLowerCase().includes('webcam'))) {
                                document.querySelector('#qr-reader video')?.classList.add('mirrored');
                            } else {
                                document.querySelector('#qr-reader video')?.classList.remove('mirrored');
                            }
                            startScanner(newCameraId);
                        }).catch(err => console.log("Gagal menghentikan scanner:", err));
                    });
                }
            }).catch(err => {
                console.error("Gagal mendapatkan daftar kamera:", err);
                document.getElementById('qr-reader').innerHTML = `<p class="text-red-500 p-4">Gagal mengakses kamera. Pastikan Anda telah memberikan izin di browser.</p>`
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setupCamera();
            fetchActiveSession();
            fetchAttendanceData();
        });
    </script>
</body>
</html>