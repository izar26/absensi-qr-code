<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Data Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; transition: margin-left .5s; }
        .sidebar { height: 100%; width: 250px; position: fixed; z-index: 20; top: 0; left: 0; background-color: #1a202c; overflow-x: hidden; transition: 0.5s; padding-top: 60px; }
        .sidebar a { padding: 10px 15px; text-decoration: none; font-size: 18px; color: #cbd5e0; display: block; transition: 0.3s; }
        .sidebar a:hover { color: #ffffff; background-color: #4a5568; }
        .sidebar .closebtn { position: absolute; top: 0; right: 25px; font-size: 36px; margin-left: 50px; display: none; }
        .main-content { transition: margin-left .5s; padding: 20px; }
        .openbtn { font-size: 20px; cursor: pointer; background-color: #1a202c; color: white; padding: 10px 15px; border: none; }
        @media screen and (max-width: 768px) {
            .sidebar { width: 0; }
            .sidebar .closebtn { display: block; }
            .main-content { margin-left: 0 !important; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="/dashboard.html"><i class="fas fa-tachometer-alt fa-fw mr-3"></i>Dashboard</a>
        <a href="/scanner.html"><i class="fas fa-qrcode fa-fw mr-3"></i>Scanner</a>
        <a href="/admin.html" class="bg-gray-700 text-white"><i class="fas fa-users-cog fa-fw mr-3"></i>Kelola Siswa</a>
        <a href="/sesi.html"><i class="fas fa-clock fa-fw mr-3"></i>Kelola Sesi</a>
        <a href="/laporan.html"><i class="fas fa-chart-bar fa-fw mr-3"></i>Laporan Harian</a>
        <a href="/grafik.html"><i class="fas fa-trophy fa-fw mr-3"></i>Grafik Peringkat</a>
        <a href="/broadcast.html"><i class="fas fa-bullhorn fa-fw mr-3"></i>Broadcast WA</a>
        <a href="/rekap.html"><i class="fas fa-file-invoice fa-fw mr-3"></i>Rekap Bulanan</a>
        <a href="/status.html"><i class="fas fa-signal fa-fw mr-3"></i>Status Sistem</a>
    </div>

    <div id="main" class="main-content">
        <button class="openbtn rounded-md mb-4" onclick="openNav()">&#9776; Menu</button>
        
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold mb-6 text-gray-800">Kelola Data Siswa</h1>
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 id="form-title" class="text-2xl font-semibold mb-4">Tambah Siswa Baru</h2>
                <form id="student-form" class="space-y-4">
                    <input type="hidden" id="student-id" name="id">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                        <input type="text" id="name" name="name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="phone_number" class="block text-sm font-medium text-gray-700">Nomor WhatsApp (Format: 628...)</label>
                        <input type="tel" id="phone_number" name="phone_number" pattern="^628[0-9]{8,12}$" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="6281234567890">
                    </div>
                     <div>
                        <label for="photo" class="block text-sm font-medium text-gray-700">Foto Siswa (Opsional)</label>
                        <input type="file" id="photo" name="photo" accept="image/png, image/jpeg" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" id="submit-btn" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-plus-circle mr-2"></i>Tambah Siswa
                        </button>
                        <button type="button" id="cancel-btn" onclick="resetForm()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 hidden">
                            Batal Edit
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <div class="relative w-full md:w-1/3">
                        <input type="text" id="search-input" placeholder="Cari nama siswa..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                    <button onclick="bulkRequestPhotos()" class="w-full md:w-auto bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 text-sm font-semibold">
                        <i class="fab fa-whatsapp mr-2"></i>Minta Foto Massal
                    </button>
                </div>
                <div id="bulk-status" class="mb-4"></div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nomor WA</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="students-table" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                     <div id="no-results" class="text-center py-8 text-gray-500 hidden">Tidak ada siswa yang cocok dengan pencarian.</div>
                </div>
                <div id="pagination-controls" class="flex justify-between items-center mt-6">
                    <span id="page-info" class="text-sm text-gray-700"></span>
                    <div class="flex items-center space-x-2">
                        <button id="prev-page" class="px-3 py-1 border rounded-md bg-white hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="page-numbers" class="flex items-center space-x-1"></span>
                        <button id="next-page" class="px-3 py-1 border rounded-md bg-white hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="qr-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">QR Code Siswa</h3>
                    <div id="modal-qr-content" class="mt-4 flex justify-center items-center flex-col"></div>
                    <div id="modal-qr-status" class="mt-2 text-center text-sm"></div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                    <button id="download-qr-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 sm:w-auto sm:text-sm" disabled>Download</button>
                    <button id="resend-qr-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:w-auto sm:text-sm" disabled><i class="fab fa-whatsapp mr-2"></i>Kirim Ulang</button>
                    <button type="button" onclick="closeQrModal()" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Sidebar Logic ---
        function openNav() {
            if (window.innerWidth > 768) {
                document.getElementById("mySidebar").style.width = "250px";
                document.getElementById("main").style.marginLeft = "250px";
            } else {
                document.getElementById("mySidebar").style.width = "250px";
            }
        }
        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            if (window.innerWidth > 768) {
                document.getElementById("main").style.marginLeft = "0";
            }
        }
        if (window.innerWidth > 768) { openNav(); }

        // --- CRUD & Page Logic ---
        const studentForm = document.getElementById('student-form');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const searchInput = document.getElementById('search-input');

        let allStudents = [];
        let currentPage = 1;
        const rowsPerPage = 10;

        document.addEventListener('DOMContentLoaded', fetchStudents);
        studentForm.addEventListener('submit', handleFormSubmit);
        searchInput.addEventListener('input', () => {
            currentPage = 1;
            renderTable();
        });

        async function fetchStudents() {
            try {
                const response = await fetch('/api/students');
                allStudents = await response.json();
                renderTable();
            } catch (error) {
                console.error('Gagal mengambil data siswa:', error);
                alert('Gagal memuat data siswa. Cek konsol untuk detail.');
            }
        }
        
        function renderTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredStudents = allStudents.filter(student => 
                student.name.toLowerCase().includes(searchTerm)
            );

            const tableBody = document.getElementById('students-table');
            const noResultsDiv = document.getElementById('no-results');
            tableBody.innerHTML = '';

            if (filteredStudents.length === 0) {
                tableBody.classList.add('hidden');
                noResultsDiv.classList.remove('hidden');
            } else {
                tableBody.classList.remove('hidden');
                noResultsDiv.classList.add('hidden');
            }

            const totalPages = Math.ceil(filteredStudents.length / rowsPerPage);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedStudents = filteredStudents.slice(start, end);

            paginatedStudents.forEach(student => {
                const photoHTML = student.photo_url
                    ? `<img src="/uploads/${student.photo_url}" alt="${student.name}" class="h-12 w-12 rounded-full object-cover">`
                    : `<div class="h-12 w-12 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-semibold">${getInitials(student.name)}</div>`;

                let requestPhotoBtn, resetStatusBtn = '';
                if (student.photo_url) {
                    requestPhotoBtn = `<button onclick="requestPhoto('${student.id}', '${student.name}')" class="text-yellow-600 hover:text-yellow-900 ml-4" title="Minta ganti foto via WhatsApp"><i class="fas fa-camera-rotate"></i> Ganti</button>`;
                } else {
                    requestPhotoBtn = `<button onclick="requestPhoto('${student.id}', '${student.name}')" class="text-blue-600 hover:text-blue-900 ml-4" title="Minta foto via WhatsApp"><i class="fab fa-whatsapp"></i> Minta</button>`;
                }
                
                // --- TOMBOL RESET DITAMBAHKAN DI SINI ---
                resetStatusBtn = `<button onclick="resetStatus('${student.id}', '${student.name}')" class="text-gray-500 hover:text-gray-800 ml-4" title="Reset Status Foto"><i class="fas fa-sync-alt"></i> Reset</button>`;
                
                const row = `
                    <tr>
                        <td class="px-6 py-4">${photoHTML}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${student.phone_number || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="showQrCode('${student.id}', '${student.name}')" class="text-green-600 hover:text-green-900" title="Tampilkan QR Code"><i class="fas fa-qrcode"></i> QR</button>
                            <button onclick="editStudent('${student.id}', '${student.name}', '${student.phone_number || ''}')" class="text-indigo-600 hover:text-indigo-900 ml-4" title="Edit Siswa"><i class="fas fa-edit"></i> Edit</button>
                            <button onclick="deleteStudent('${student.id}', '${student.name}')" class="text-red-600 hover:text-red-900 ml-4" title="Hapus Siswa"><i class="fas fa-trash"></i> Hapus</button>
                            ${requestPhotoBtn}
                            ${resetStatusBtn}
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            renderPaginationControls(filteredStudents.length, totalPages);
        }

        function renderPaginationControls(totalItems, totalPages) {
            const pageInfo = document.getElementById('page-info');
            const pageNumbers = document.getElementById('page-numbers');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');

            if (totalPages <= 1) {
                document.getElementById('pagination-controls').classList.add('hidden');
                return;
            }
            
            document.getElementById('pagination-controls').classList.remove('hidden');

            const startItem = (currentPage - 1) * rowsPerPage + 1;
            const endItem = Math.min(currentPage * rowsPerPage, totalItems);
            pageInfo.textContent = `Menampilkan ${startItem}-${endItem} dari ${totalItems} siswa`;

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            prevBtn.onclick = () => { if(currentPage > 1) { currentPage--; renderTable(); } };
            nextBtn.onclick = () => { if(currentPage < totalPages) { currentPage++; renderTable(); } };
            
            // Logika untuk menampilkan nomor halaman (opsional, bisa dibuat lebih kompleks)
            pageNumbers.innerHTML = `<span class="px-3 py-1 border rounded-md bg-indigo-500 text-white">${currentPage}</span>`;
        }

        async function handleFormSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('student-id').value;
    const formData = new FormData(studentForm);

    const url = id ? `/api/students/${id}` : '/api/students';
    // Saat mengedit (ada id), kita gunakan method 'PUT'
    const method = id ? 'PUT' : 'POST';

    // Ini adalah bagian penting:
    // Hapus field 'photo' dari data yang akan dikirim jika sedang mode edit 
    // DAN tidak ada file baru yang dipilih.
    // Ini mencegah server menerima file kosong.
    if (id && formData.get('photo') && !formData.get('photo').size) {
        formData.delete('photo');
    }

    try {
        const response = await fetch(url, {
            method: method,
            body: formData // Kirim semua data sebagai FormData secara konsisten
        });

        const result = await response.json();
        if (!response.ok) {
            throw new Error(result.message || `Gagal ${id ? 'memperbarui' : 'menambah'} siswa.`);
        }
        
        // Gunakan pesan dari server agar lebih dinamis
        alert(result.message); 
        resetForm();
        fetchStudents(); // Muat ulang data tabel untuk melihat perubahan

    } catch (error) {
        console.error(error);
        alert(error.message);
    }
}


        function editStudent(id, name, phone) {
            document.getElementById('student-id').value = id;
            document.getElementById('name').value = name;
            document.getElementById('phone_number').value = phone;
            formTitle.textContent = 'Edit Data Siswa';
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Perubahan';
            cancelBtn.classList.remove('hidden');
            window.scrollTo(0, 0);
        }
        
        function resetForm() {
            studentForm.reset();
            document.getElementById('student-id').value = '';
            formTitle.textContent = 'Tambah Siswa Baru';
            submitBtn.innerHTML = '<i class="fas fa-plus-circle mr-2"></i>Tambah Siswa';
            cancelBtn.classList.add('hidden');
        }

        async function deleteStudent(id, name) {
            if (!confirm(`Apakah Anda yakin ingin menghapus '${name}'?`)) return;
            try {
                const response = await fetch(`/api/students/${id}`, { method: 'DELETE' });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.message || 'Gagal menghapus siswa.');
                }
                fetchStudents();
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
        }
        
        // --- Fungsi Tombol Aksi Baru ---

        // Fungsi Tombol Reset Status (Tombol Darurat)
        async function resetStatus(id, name) {
            if (!confirm(`Anda yakin ingin mereset status permintaan foto untuk '${name}'? Lakukan ini jika permintaan sebelumnya macet.`)) return;
            try {
                const response = await fetch(`/api/students/${id}/reset-status`, { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                alert(result.message);
                // Opsi: Muat ulang data untuk melihat perubahan status jika ada indikator visual
                // fetchStudents(); 
            } catch (error) {
                console.error('Gagal mereset status:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        const qrModal = document.getElementById('qr-modal');
        const qrContent = document.getElementById('modal-qr-content');
        const qrStatus = document.getElementById('modal-qr-status');
        const downloadBtn = document.getElementById('download-qr-btn');
        const resendBtn = document.getElementById('resend-qr-btn');

        async function showQrCode(id, name) {
            qrModal.classList.remove('hidden');
            qrContent.innerHTML = '<p class="text-gray-500">Membuat QR Code...</p>';
            qrStatus.innerHTML = '';
            downloadBtn.disabled = true;
            resendBtn.disabled = true;

            try {
                const response = await fetch(`/api/qr-code/${id}`);
                if (!response.ok) throw new Error('Gagal memuat data QR Code dari server.');
                const data = await response.json();
                
                const img = new Image();
                img.src = data.qrData;
                img.className = 'w-64 h-auto';
                
                qrContent.innerHTML = '';
                qrContent.appendChild(img);

                downloadBtn.disabled = false;
                resendBtn.disabled = false;

                downloadBtn.onclick = () => {
                    const link = document.createElement('a');
                    link.download = `qr-code-${name.toLowerCase().replace(/\s+/g, '-')}.png`;
                    link.href = data.qrData;
                    link.click();
                };

                resendBtn.onclick = () => resendQrViaWhatsApp(id);

            } catch (error) {
                console.error("Error showing QR Code:", error);
                qrContent.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        }

        function closeQrModal() {
            qrModal.classList.add('hidden');
        }

        async function resendQrViaWhatsApp(id) {
            qrStatus.innerHTML = '<p class="text-blue-600">Mengirim via WhatsApp...</p>';
            resendBtn.disabled = true;
            try {
                const response = await fetch(`/api/students/${id}/resend-qr`, { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                qrStatus.innerHTML = `<p class="text-green-600">${result.message}</p>`;
                setTimeout(() => {
                    closeQrModal();
                }, 2000);

            } catch (error) {
                console.error("Error resending QR Code:", error);
                qrStatus.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
                resendBtn.disabled = false;
            }
        }

        async function requestPhoto(id, name) {
            if (!confirm(`Anda akan mengirim permintaan foto ke ${name} via WhatsApp. Lanjutkan?`)) return;
            try {
                const response = await fetch(`/api/students/${id}/request-photo`, { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                alert(result.message);
            } catch (error) {
                console.error('Gagal meminta foto:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        async function bulkRequestPhotos() {
            if (!confirm('Anda akan mengirim permintaan foto ke SEMUA siswa yang belum memiliki foto. Proses ini akan berjalan di latar belakang. Lanjutkan?')) return;
            const statusDiv = document.getElementById('bulk-status');
            statusDiv.innerHTML = `<div class="p-4 bg-blue-100 text-blue-700 rounded-md">Memulai proses...</div>`;
            try {
                const response = await fetch('/api/students/bulk-request-photo', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                statusDiv.innerHTML = `<div class="p-4 bg-green-100 text-green-700 rounded-md">${result.message}</div>`;
            } catch (error) {
                statusDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-md">Error: ${error.message}</div>`;
            }
        }

        function getInitials(name) {
            if (!name) return '';
            return name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
        }
    </script>
</body>
</html>