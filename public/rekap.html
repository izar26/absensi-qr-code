<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapitulasi Absensi Bulanan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; transition: margin-left .5s; }
        .sidebar { height: 100%; width: 250px; position: fixed; z-index: 20; top: 0; left: 0; background-color: #1a202c; overflow-x: hidden; transition: 0.5s; padding-top: 60px; }
        .sidebar a { padding: 10px 15px; text-decoration: none; font-size: 18px; color: #cbd5e0; display: block; transition: 0.3s; }
        .sidebar a:hover { color: #ffffff; background-color: #4a5568; }
        .sidebar .closebtn { position: absolute; top: 0; right: 25px; font-size: 36px; margin-left: 50px; display: none; }
        .main-content { transition: margin-left .5s; padding: 20px; }
        .openbtn { font-size: 20px; cursor: pointer; background-color: #1a202c; color: white; padding: 10px 15px; border: none; }
        .sticky-header { position: sticky; top: 0; }
        .sticky-col { position: sticky; left: 0; background-color: white; z-index: 10;}
        table { border-collapse: separate; border-spacing: 0; }
        td, th { border: 1px solid #e2e8f0; }
        @media screen and (max-width: 768px) {
            .sidebar { width: 0; }
            .sidebar .closebtn { display: block; }
            .main-content { margin-left: 0 !important; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="/dashboard.html"><i class="fas fa-tachometer-alt fa-fw mr-3"></i>Dashboard</a>
        <a href="/scanner.html"><i class="fas fa-qrcode fa-fw mr-3"></i>Scanner</a>
        <a href="/admin.html"><i class="fas fa-users-cog fa-fw mr-3"></i>Kelola Siswa</a>
        <a href="/sesi.html"><i class="fas fa-clock fa-fw mr-3"></i>Kelola Sesi</a>
        <a href="/laporan.html"><i class="fas fa-chart-bar fa-fw mr-3"></i>Laporan Harian</a>
        <a href="/grafik.html"><i class="fas fa-trophy fa-fw mr-3"></i>Grafik Peringkat</a>
        <a href="/broadcast.html"><i class="fas fa-bullhorn fa-fw mr-3"></i>Broadcast WA</a>
        <a href="/rekap.html" class="bg-gray-700 text-white"><i class="fas fa-file-invoice fa-fw mr-3"></i>Rekap Bulanan</a>
        <a href="/status.html"><i class="fas fa-signal fa-fw mr-3"></i>Status Sistem</a>
    </div>

    <div id="main" class="main-content">
        <button class="openbtn rounded-md mb-4" onclick="openNav()">&#9776; Menu</button>
        
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold mb-2 text-gray-800">Rekapitulasi Absensi Bulanan</h1>
            <p class="text-gray-600 mb-6">Pilih bulan dan tahun untuk melihat rekapitulasi kehadiran dan mengunduhnya sebagai file CSV.</p>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <!-- Filter Section -->
                <div class="flex flex-wrap items-center gap-4 mb-6">
                    <div>
                        <label for="month-select" class="block text-sm font-medium text-gray-700">Bulan:</label>
                        <select id="month-select" class="mt-1 block w-full md:w-auto pl-3 pr-10 py-2 border-gray-300 rounded-md"></select>
                    </div>
                    <div>
                        <label for="year-select" class="block text-sm font-medium text-gray-700">Tahun:</label>
                        <select id="year-select" class="mt-1 block w-full md:w-auto pl-3 pr-10 py-2 border-gray-300 rounded-md"></select>
                    </div>
                    <button id="show-report-btn" class="self-end bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Tampilkan Laporan</button>
                    <button id="download-csv-btn" class="self-end bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:bg-green-400 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-file-csv mr-2"></i>Download CSV
                    </button>
                </div>

                <!-- Report Table Section -->
                <div id="report-container" class="overflow-auto max-h-[60vh] border rounded-lg">
                    <!-- Tabel akan di-generate di sini -->
                </div>
                <div id="loading-indicator" class="text-center py-8 hidden">Memuat data...</div>

            </div>
        </div>
    </div>

    <script>
        // --- Sidebar Logic ---
        function openNav() {
            if (window.innerWidth > 768) { document.getElementById("main").style.marginLeft = "250px"; }
            document.getElementById("mySidebar").style.width = "250px";
        }
        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            if (window.innerWidth > 768) { document.getElementById("main").style.marginLeft = "0"; }
        }
        if (window.innerWidth > 768) { openNav(); }

        // --- Rekap Logic ---
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const showBtn = document.getElementById('show-report-btn');
        const downloadBtn = document.getElementById('download-csv-btn');
        const reportContainer = document.getElementById('report-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        let reportData = null; // Menyimpan data laporan untuk download

        // Populate selectors
        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        months.forEach((month, index) => {
            const option = new Option(month, index + 1);
            monthSelect.add(option);
        });
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= currentYear - 5; year--) {
            const option = new Option(year, year);
            yearSelect.add(option);
        }
        monthSelect.value = new Date().getMonth() + 1;
        yearSelect.value = currentYear;

        // Fetch and render report
        showBtn.addEventListener('click', async () => {
            const month = monthSelect.value;
            const year = yearSelect.value;
            
            loadingIndicator.classList.remove('hidden');
            reportContainer.innerHTML = '';
            downloadBtn.disabled = true;
            reportData = null;

            try {
                const response = await fetch(`/api/report/monthly?year=${year}&month=${month}`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Gagal mengambil data.');
                }
                reportData = await response.json();
                renderTable(reportData);
                downloadBtn.disabled = false;
            } catch (error) {
                reportContainer.innerHTML = `<p class="text-red-500 text-center p-4">${error.message}</p>`;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        function renderTable(data) {
            if (!data || data.rows.length === 0) {
                reportContainer.innerHTML = '<p class="text-gray-500 text-center p-4">Tidak ada data absensi untuk periode ini.</p>';
                return;
            }
            let tableHTML = '<table class="min-w-full text-sm text-center">';
            // Headers
            tableHTML += '<thead class="bg-gray-100 sticky-header">';
            tableHTML += '<tr>';
            data.headers.forEach((header, index) => {
                tableHTML += `<th class="py-2 px-2 font-semibold text-gray-600 ${index === 0 ? 'sticky-col' : ''}">${header}</th>`;
            });
            tableHTML += '</tr></thead>';
            // Body
            tableHTML += '<tbody class="bg-white">';
            data.rows.forEach(row => {
                tableHTML += '<tr>';
                data.headers.forEach((header, index) => {
                    const value = row[header] || '-';
                    tableHTML += `<td class="py-2 px-2 ${index === 0 ? 'sticky-col text-left font-medium' : ''}">${value}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            reportContainer.innerHTML = tableHTML;
        }

        // Download CSV logic
        downloadBtn.addEventListener('click', () => {
            if (!reportData) return;
            const { headers, rows } = reportData;
            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                const csvRow = headers.map(header => {
                    const value = row[header] || '';
                    // Handle comma in value by enclosing in quotes
                    return `"${value}"`;
                }).join(',');
                csvContent += csvRow + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const monthName = months[monthSelect.value - 1];
            link.setAttribute("download", `Rekap_Absensi_${monthName}_${yearSelect.value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>
